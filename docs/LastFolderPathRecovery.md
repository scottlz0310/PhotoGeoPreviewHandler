# LastFolderPath リカバリの改善

## 概要

このドキュメントは、LastFolderPath の無効パス処理の改善について説明します。

## 問題

以前の実装では、設定ファイルに保存された `LastFolderPath` が無効な場合（例: フォルダが削除された、ドライブが外された、ネットワークパスが利用不可）、単にそのパスを無視し、`InitializeAsync` で Pictures フォルダにフォールバックしていました。

この動作は、ユーザーが深い階層で作業していた場合、その作業コンテキストが完全に失われる問題がありました。

### 例

ユーザーが以下のパスで作業していたとします：

```
D:\Photos\2025\12月\旅行\鎌倉
```

このフォルダ内の "鎌倉" フォルダだけが削除された場合、以前の実装では Pictures フォルダ（通常は `C:\Users\<username>\Pictures`）にフォールバックし、作業コンテキストが完全に失われていました。

## 改善内容

新しい実装では、無効なパスが検出された場合、親フォルダに順次フォールバックするようになりました。

### 動作

1. `LastFolderPath` が無効（存在しない）場合、親フォルダをチェック
2. 親フォルダも無効な場合、さらにその親をチェック
3. 有効な祖先フォルダが見つかるまで繰り返す
4. すべての祖先が無効な場合（例: ドライブ全体が存在しない）、`null` を返す
5. `null` が返された場合、既存の動作通り `InitializeAsync` で Pictures フォルダにフォールバック

### 例（改善後）

同じシナリオで、"鎌倉" フォルダが削除された場合：

```
元のパス:     D:\Photos\2025\12月\旅行\鎌倉  (存在しない)
チェック1:    D:\Photos\2025\12月\旅行        (存在する ✓)
→ このフォルダにフォールバック
```

ドライブ全体がマウント解除された場合：

```
元のパス:     D:\Photos\2025\12月\旅行\鎌倉  (存在しない)
チェック1:    D:\Photos\2025\12月\旅行        (存在しない)
チェック2:    D:\Photos\2025\12月             (存在しない)
チェック3:    D:\Photos\2025                  (存在しない)
チェック4:    D:\Photos                       (存在しない)
チェック5:    D:\                             (存在しない)
→ null を返し、Pictures フォルダにフォールバック
```

## 実装詳細

### FindValidAncestorPath メソッド

```csharp
private static string? FindValidAncestorPath(string? path)
```

このメソッドは以下の処理を行います：

1. 入力パスを正規化（`Path.GetFullPath`）
2. パスが存在するかチェック（`Directory.Exists`）
3. 存在しない場合、親フォルダを取得（`Directory.GetParent`）
4. 親フォルダでステップ2～3を繰り返す
5. 有効な祖先が見つかればそのパスを返す
6. ルートまで到達しても見つからなければ `null` を返す

**注意**: パラメータは `string?` で nullable を明示的に受け入れます。

### 設定の永続化

リカバリが成功した場合（有効な祖先フォルダが見つかった場合）、`settings.LastFolderPath` を更新し、`SettingsService` を通じて保存します。これにより：

- 次回起動時に同じリカバリ処理を繰り返さない
- ログノイズを抑制
- ユーザーの現在の状態を正確に保存

### エラーハンドリング

以下の例外をキャッチし、適切にログ出力します：

- `ArgumentException`: 無効なパス形式
- `PathTooLongException`: パスが長すぎる
- `System.Security.SecurityException`: アクセス権限がない
- `NotSupportedException`: サポートされていないパス形式
- `UnauthorizedAccessException`: アクセス権限がない（ディレクトリアクセス時）

### ログ出力

リカバリが発生した場合、以下のようなログが出力されます：

```
2026-01-14 13:00:00.000 +09:00 [INFO] LastFolderPath recovered from 'D:\Photos\2025\12月\旅行\鎌倉' to ancestor 'D:\Photos\2025\12月\旅行'
```

設定ファイルも更新され、次回起動時には復元されたパスが直接使用されます。

## テスト

`LastFolderPathRecoveryTests.cs` に以下のテストケースが含まれています：

1. **有効なパスの場合**: そのまま返す
2. **子フォルダが存在しない場合**: 親フォルダを返す
3. **複数階層が存在しない場合**: 最も近い有効な祖先を返す
4. **すべての祖先が無効な場合**: `null` を返す
5. **空文字列/null の場合**: `null` を返す
6. **相対パスの場合**: 正しく処理する
7. **深い階層の場合**: 正しくトラバースする

## 互換性

この変更は既存の動作を改善するものであり、後方互換性を保っています：

- 有効な `LastFolderPath` の場合、以前と同じ動作
- 無効な `LastFolderPath` で祖先も存在しない場合、以前と同じ Pictures フォルダにフォールバック
- 新しいリカバリ動作により、ユーザーエクスペリエンスが向上

## 使用シナリオ

この改善は以下のシナリオで役立ちます：

1. **一時的なフォルダの削除**: プロジェクトフォルダ内のサブフォルダを整理した際
2. **外部ドライブの取り外し**: USB ドライブや SD カードを取り外した後の起動
3. **ネットワークドライブの切断**: ネットワークパスが一時的に利用不可の場合
4. **クラウドストレージの同期状態**: OneDrive や Dropbox などでフォルダが同期中の場合

すべてのケースで、可能な限りユーザーの作業コンテキストに近い場所を維持します。

## 関連ファイル

- `PhotoGeoExplorer/MainWindow.xaml.cs`: 実装
- `PhotoGeoExplorer.Tests/LastFolderPathRecoveryTests.cs`: テスト
- `PhotoGeoExplorer.Core/Models/AppSettings.cs`: LastFolderPath の定義
- `CHANGELOG.md`: 変更履歴
