# LastFolderPath パスリカバリ動作の比較

## 従来の動作

```
設定ファイル: LastFolderPath = "D:\Photos\2025\12月\旅行\鎌倉"
                                    ↓
                          フォルダが存在するか？
                                    ↓
                            [存在しない]
                                    ↓
                            設定を無視
                                    ↓
                        InitializeAsync()
                                    ↓
                        OpenHomeAsync()
                                    ↓
                    Pictures フォルダにフォールバック
                    (C:\Users\<username>\Pictures)
                                    ↓
                    ❌ 作業コンテキストが完全に失われる
```

## 改善後の動作

```
設定ファイル: LastFolderPath = "D:\Photos\2025\12月\旅行\鎌倉"
                                    ↓
                        FindValidAncestorPath()
                                    ↓
                D:\Photos\2025\12月\旅行\鎌倉 が存在するか？
                                    ↓
                            [存在しない]
                                    ↓
                D:\Photos\2025\12月\旅行 が存在するか？
                                    ↓
                            [存在する ✓]
                                    ↓
                    このパスを返す
                                    ↓
                LoadFolderAsync(D:\Photos\2025\12月\旅行)
                                    ↓
        ✅ 作業コンテキストが保持される（1階層上の親フォルダ）
                                    ↓
            ログ出力:
            "LastFolderPath recovered from 
             'D:\Photos\2025\12月\旅行\鎌倉' 
             to ancestor 'D:\Photos\2025\12月\旅行'"
```

## 複数階層が存在しない場合

```
設定ファイル: LastFolderPath = "D:\Photos\2025\12月\旅行\鎌倉"
                                    ↓
                        FindValidAncestorPath()
                                    ↓
                D:\Photos\2025\12月\旅行\鎌倉 が存在するか？
                                    ↓
                            [存在しない]
                                    ↓
                D:\Photos\2025\12月\旅行 が存在するか？
                                    ↓
                            [存在しない]
                                    ↓
                D:\Photos\2025\12月 が存在するか？
                                    ↓
                            [存在しない]
                                    ↓
                D:\Photos\2025 が存在するか？
                                    ↓
                            [存在する ✓]
                                    ↓
                    このパスを返す
                                    ↓
                LoadFolderAsync(D:\Photos\2025)
                                    ↓
        ✅ 作業コンテキストが部分的に保持される（3階層上）
```

## ドライブ全体が存在しない場合

```
設定ファイル: LastFolderPath = "D:\Photos\2025\12月\旅行\鎌倉"
                                    ↓
                        FindValidAncestorPath()
                                    ↓
                D:\Photos\2025\12月\旅行\鎌倉 が存在するか？
                                    ↓
                            [存在しない]
                                    ↓
                        （親フォルダを順次チェック...）
                                    ↓
                            D:\ が存在するか？
                                    ↓
                            [存在しない]
                                    ↓
                        ルートに到達、null を返す
                                    ↓
                        InitializeAsync()
                                    ↓
                        OpenHomeAsync()
                                    ↓
                    Pictures フォルダにフォールバック
                    (C:\Users\<username>\Pictures)
                                    ↓
        ⚠️ 従来と同じ動作（代替手段がない場合）
```

## 利点の比較

| シナリオ | 従来の動作 | 改善後の動作 | 利点 |
|---------|----------|------------|------|
| 1階層削除 | Pictures フォルダ | 親フォルダ | ✅ 作業コンテキスト完全保持 |
| 複数階層削除 | Pictures フォルダ | 最も近い祖先 | ✅ 作業コンテキスト部分保持 |
| ドライブ削除 | Pictures フォルダ | Pictures フォルダ | 同じ（代替なし） |
| 有効なパス | そのまま | そのまま | 同じ（互換性維持） |

## 実装の特徴

### 安全性
- 例外ハンドリングを実装
- 無限ループを防止（ルート到達で停止）
- null 安全性を確保

### 透明性
- リカバリ時にログ出力
- ユーザーに何が起きたか追跡可能

### パフォーマンス
- O(n) の複雑度（n = ディレクトリの深さ）
- 最悪ケースでもルートまでの階層数のみ

### 互換性
- 既存の動作を変更しない
- 有効なパスはそのまま使用
- 無効な場合のフォールバックが改善
