# GitHub Actions workflow for release packaging

name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate release version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          if (-not $tag.StartsWith("v")) {
            Write-Error "Tag must start with 'v' (example: v1.0.0)."
            exit 1
          }
          $version = $tag.TrimStart("v")
          if ([string]::IsNullOrWhiteSpace($version)) {
            Write-Error "Tag version is empty."
            exit 1
          }

          [xml]$wix = Get-Content -Path "PhotoGeoExplorer.Installer/PhotoGeoExplorer.Installer.wixproj" -Raw
          $productVersion = ($wix.Project.PropertyGroup.ProductVersion | Select-Object -First 1).Trim()
          if ($productVersion -ne $version) {
            Write-Error "Installer ProductVersion ($productVersion) must match tag ($version)."
            exit 1
          }

          [xml]$manifest = Get-Content -Path "PhotoGeoExplorer/Package.appxmanifest" -Raw
          $manifestVersion = $manifest.Package.Identity.Version
          $expectedManifest = "$version.0"
          if ($manifestVersion -ne $expectedManifest) {
            Write-Error "Appxmanifest Version ($manifestVersion) must match $expectedManifest."
            exit 1
          }

          [xml]$app = Get-Content -Path "PhotoGeoExplorer/PhotoGeoExplorer.csproj" -Raw
          $appVersion = ($app.Project.PropertyGroup.Version | Select-Object -First 1).Trim()
          if ($appVersion -ne $version) {
            Write-Error "App Version ($appVersion) must match tag ($version)."
            exit 1
          }

          $expectedAssembly = "$version.0"
          $assemblyVersion = ($app.Project.PropertyGroup.AssemblyVersion | Select-Object -First 1).Trim()
          if ($assemblyVersion -ne $expectedAssembly) {
            Write-Error "AssemblyVersion ($assemblyVersion) must match $expectedAssembly."
            exit 1
          }

          $fileVersion = ($app.Project.PropertyGroup.FileVersion | Select-Object -First 1).Trim()
          if ($fileVersion -ne $expectedAssembly) {
            Write-Error "FileVersion ($fileVersion) must match $expectedAssembly."
            exit 1
          }

          $infoVersion = ($app.Project.PropertyGroup.InformationalVersion | Select-Object -First 1).Trim()
          if ($infoVersion -ne $version) {
            Write-Error "InformationalVersion ($infoVersion) must match tag ($version)."
            exit 1
          }

          $changelog = Get-Content -Path "CHANGELOG.md"
          if (-not ($changelog | Select-String -SimpleMatch "## [$version]")) {
            Write-Error "CHANGELOG.md must include a section for [$version]."
            exit 1
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Restore
        run: dotnet restore PhotoGeoExplorer.sln

      - name: Build MSI
        run: dotnet build PhotoGeoExplorer.Installer\PhotoGeoExplorer.Installer.wixproj -c Release -p:Platform=x64

      - name: Collect installer artifacts
        shell: pwsh
        run: |
          $packages = Get-ChildItem -Path PhotoGeoExplorer.Installer -Recurse -File -Include *.msi
          if (-not $packages) {
            Write-Error "No installer packages found."
            exit 1
          }
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          foreach ($package in $packages) {
            Copy-Item $package.FullName -Destination artifacts -Force
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: installer
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
